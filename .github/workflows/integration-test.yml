name: Run integration test

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: ${{ github.workspace }}/isle-site-template/docker-compose.yml
      TERM: xterm
    steps:
      - name: Checkout isle-site-template
        uses: actions/checkout@v6
        with:
          repository: Islandora-Devops/isle-site-template
          path: isle-site-template

      - name: Start islandora-starter-site
        working-directory: isle-site-template
        run: make up

      - name: Checkout workbench
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: 3.11

      - name: Install dependencies  
        run: |  
          python -m pip install --upgrade pip  
          python setup.py install

          # disable media standalone URL
          docker compose exec drupal drush config:set media.settings standalone_url FALSE -y
          docker compose exec drupal drush cr

      - name: Update file media type to allow jpg extension
        run: |
          EXTS=$(docker compose exec drupal drush config:get field.field.media.file.field_media_file settings.file_extensions | sed -E "s/.*: '(.*)'/\1/") 
          if echo "$EXTS" | grep -qw "jpg"; then
            echo "jpg already present"
          else
            NEW_EXTS="$EXTS jpg"
            echo "Updating extensions to: $NEW_EXTS"
            docker compose exec drupal drush config:set field.field.media.file.field_media_file settings.file_extensions "$NEW_EXTS" -y
          fi

      - name: Explicitly state the admin password
        run: docker compose exec drupal drush user:password admin 'admin'

      - name: Create workbench_user role
        run: |
          docker compose exec drupal drush role:create workbench_user
          docker compose exec drupal drush role:perm:add workbench_user "$(cat tests/assets/user-role-permissions.txt | sed '/^$/d' | tr '\n' ',')"

      - name: Create test user with workbench_user role
        run: |
          docker compose exec drupal drush user:create test-user --mail='test@noreply.com' --password='testPassword'
          docker compose exec drupal drush user:role:add workbench_user test-user

      - name: Run islandora_tests_check
        run: pytest -v --no-header tests/islandora_tests_check.py
        env:
          REQUESTS_CA_BUNDLE: ${{ github.workspace }}/isle-site-template/certs/rootCA.pem
          
      - name: Run islandora_tests_paged_content  
        run: pytest -v --no-header tests/islandora_tests_paged_content.py
        env:
          REQUESTS_CA_BUNDLE: ${{ github.workspace }}/isle-site-template/certs/rootCA.pem

      - name: Run islandora_tests  
        run: pytest -v --no-header tests/islandora_tests.py

      - name: Run islandora_tests_recovery_mode
        run: pytest -v --no-header tests/islandora_tests_recovery_mode.py
        env:
          REQUESTS_CA_BUNDLE: ${{ github.workspace }}/isle-site-template/certs/rootCA.pem        

      - name: Run csv_id_to_node_id_map_tests  
        run: python tests/csv_id_to_node_id_map_tests.py

      # DEBUG ARTIFACTS - Add these steps at the end
      - name: Collect debug artifacts on failure
        if: failure()
        run: |
          mkdir -p debug-artifacts
          # Docker container logs
          echo "=== Docker container logs ===" > debug-artifacts/docker-info.log
          docker ps -a >> debug-artifacts/docker-info.log
          echo -e "\n=== Drupal container logs ===" >> debug-artifacts/docker-info.log
          docker logs isle-site-template-drupal-dev-1 >> debug-artifacts/drupal.log 2>&1 || echo "Could not get Drupal logs"

          # Drupal status and configuration
          docker compose exec drupal drush status > debug-artifacts/drupal-status.txt 2>&1 || echo "Could not get Drupal status"
          docker compose exec drupal drush config:get system.site > debug-artifacts/site-config.txt 2>&1 || echo "Could not get site config"

          # Environment variables and Python info
          env | grep -E "(PYTHON|PATH|PWD)" > debug-artifacts/environment.txt
          python --version >> debug-artifacts/environment.txt
          pip list >> debug-artifacts/pip-packages.txt 2>&1 || echo "Could not list pip packages"

      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: debug-artifacts-${{ github.run_id }}
          path: debug-artifacts/
          retention-days: 7
